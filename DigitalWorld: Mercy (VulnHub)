OS: Ubuntu

Web Technology: Apache Tomcat/Coyote JSP engine 1.1

IP:

USERS:
local users
pleadformercy
qiu
thisisasuperduperlonguser
fluffy

CREDENTIALS:

#####################################################
 Attack Vectors (To-Try List):

22 → SSH → 

53 → ISC BIND 9 → what? → 

80 → HTTP → port unreachable →  manual inspection → discover CMS → directory/file fuzzing → 

110 → Dovecot POP3d → what? → Unencrypted connection →  

139 → Samba → enum4linux → anonymous login → file shares → 

143 → Dovecat imapd → what? → 

445 → Samba → enum4linux → anonymous login → file shares → 

993 → Dovecot imapd → what? → 

995 → Dovecot pop3d → what? → Encrypted Connection → 

8080 → manual inspection → discover CMS → directory/file fuzzing

#####################################################
NMAP RESULTS:
nmap -Pn -n -vvv -sC -sV -oN scan 192.168.1.103
22/tcp   filtered ssh         port-unreach ttl 64

53/tcp   open     domain      syn-ack ttl 64      ISC BIND 9.9.5-3ubuntu0.17 (Ubuntu Linux)
| dns-nsid: 
|_  bind.version: 9.9.5-3ubuntu0.17-Ubuntu

80/tcp   filtered http        port-unreach ttl 64
	knock 192.168.1.103 159 27391 4
	80/tcp   open     http        syn-ack ttl 64      Apache httpd 2.4.7 ((Ubuntu))
		|_http-server-header: Apache/2.4.7 (Ubuntu)
		| http-methods: 
		|_  Supported Methods: OPTIONS GET HEAD POST
		|_http-title: Site doesn't have a title (text/html).
		| http-robots.txt: 2 disallowed entries 
		|_/mercy /nomercy

110/tcp  open     pop3        syn-ack ttl 64      Dovecot pop3d
	nmap --script "pop3-capabilities" -sV  192.168.1.103 -p 110 
	|_pop3-capabilities: SASL STLS TOP PIPELINING AUTH-RESP-CODE RESP-CODES CAPA UIDL

139/tcp  open     netbios-ssn syn-ack ttl 64      Samba smbd 3.X - 4.X (workgroup: WORKGROUP)

143/tcp  open     imap        syn-ack ttl 64      Dovecot imapd (Ubuntu)

445/tcp  open     netbios-ssn syn-ack ttl 64      Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)

993/tcp  open     ssl/imap    syn-ack ttl 64      Dovecot imapd (Ubuntu)

995/tcp  open     ssl/pop3    syn-ack ttl 64      Dovecot pop3d
	nmap --script "pop3-capabilities" -sV  192.168.1.103 -p 995  
	|_pop3-capabilities: SASL(PLAIN) USER RESP-CODES CAPA UIDL TOP AUTH-RESP-CODE PIPELINING


8080/tcp open     http        syn-ack ttl 64      Apache Tomcat/Coyote JSP engine 1.1
|_http-server-header: Apache-Coyote/1.1
|_http-title: Apache Tomcat
| http-robots.txt: 1 disallowed entry 
|_/tryharder/tryharder
|_http-open-proxy: Proxy might be redirecting requests
| http-methods: 
|   Supported Methods: GET HEAD POST PUT DELETE OPTIONS
|_  Potentially risky methods: PUT DELETE
MAC Address: 08:00:27:34:3D:C5 (Oracle VirtualBox virtual NIC)
Service Info: Host: MERCY; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: -2h40m15s, deviation: 4h37m07s, median: -15s
| nbstat: NetBIOS name: MERCY, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| Names:
|   MERCY<00>            Flags: <unique><active>
|   MERCY<03>            Flags: <unique><active>
|   MERCY<20>            Flags: <unique><active>
|   \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
|   WORKGROUP<00>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|   WORKGROUP<1e>        Flags: <group><active>
| Statistics:
|   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
|   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
|_  00 00 00 00 00 00 00 00 00 00 00 00 00 00
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 39712/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 64091/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 62198/udp): CLEAN (Failed to receive data)
|   Check 4 (port 37318/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-time: 
|   date: 2022-05-05T23:58:54
|_  start_date: N/A
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
|   Computer name: mercy
|   NetBIOS computer name: MERCY\x00
|   Domain name: \x00
|   FQDN: mercy
|_  System time: 2022-05-06T07:58:54+08:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required

#####################################################
Steps Taken():
[+] nmap -Pn -n -vvv -sC -sV -oN scan 192.168.1.103
[+] enum4linux $IP
[+] wfuzz $IP on 8080
→ the directory/file "tryharder/tryharder suggests that a user has a password set as ‘password’ somewhere
[+] access to the /qiu share with qiu:password
[+] within the qiu share, a config file revealing the use of a port knock daemon 
[+] the port knock sequence opens port 80 
[+] http://192.168.1.103/nomercy/ → RIPS vulnerability scanner → vulnerable to LFI
[+] the LFI of tomcat-users.xml reveals the admin-gui username and password
→ thisisasuperduperlonguser:heartbreakisinevitable
[+] http://192.168.1.103:8080/manager/html → WAR file upload → reverse shell
[+] enumeration leads to switching to the user ‘fluffy’
[+] in /home/fluffy/.private/secrets
→ the file timeclock is owned by root
→ we have write permissions on this executable file
→ in the executable, ownership is transferred to www-data
→ injecting a bad string of characters will give us a reverse shell

#####################################################
Web Services Enumeration:  

[  +  NIKTO   ]

[  +  WFUZZ  ]

FILES:   /   (Web Root)
80
main.php

8080
"robots.txt" 

DIRECTORIES:  /  (Web Root)
80
css
js
lib
config
windows 

8080
docs
manager 
examples
host-manager
OTHER:  
enum4linux $IP
        MERCY           <00> -         B <ACTIVE>  Workstation Service
        MERCY           <03> -         B <ACTIVE>  Messenger Service
        MERCY           <20> -         B <ACTIVE>  File Server Service
        ..__MSBROWSE__. <01> - <GROUP> B <ACTIVE>  Master Browser
        WORKGROUP       <00> - <GROUP> B <ACTIVE>  Domain/Workgroup Name
        WORKGROUP       <1d> -         B <ACTIVE>  Master Browser
        WORKGROUP       <1e> - <GROUP> B <ACTIVE>  Browser Service Elections

[+] Server 192.168.1.103 allows sessions using username '', password ''

[+] Got OS info for 192.168.1.103 from srvinfo:                                                                                                                                                                                            
        MERCY          Wk Sv PrQ Unx NT SNT MERCY server (Samba, Ubuntu)                                                                                                                                                                   
        platform_id     :       500
        os version      :       6.1
        server type     :       0x809a03
                                                                                                                                                                                                                                           
index: 0x1 RID: 0x3e8 acb: 0x00000010 Account: pleadformercy    Name: QIU       Desc:                                                                                                                                                      
index: 0x2 RID: 0x3e9 acb: 0x00000010 Account: qiu      Name:   Desc: 
user:[pleadformercy] rid:[0x3e8]
user:[qiu] rid:[0x3e9]

        Sharename       Type      Comment
        ---------       ----      -------
        print$          Disk      Printer Drivers
        qiu             Disk      
        IPC$            IPC       IPC Service (MERCY server (Samba, Ubuntu))
                                                                                                                                                                                                                                           
//192.168.1.103/print$  Mapping: DENIED Listing: N/A Writing: N/A                                                                                                                                                                          
//192.168.1.103/qiu     Mapping: DENIED Listing: N/A Writing: N/A
//192.168.1.103/IPC$    Mapping: N/A Listing: N/A Writing: N/A
[+] Found domain(s):
        [+] MERCY
        [+] Builtin
Password Complexity: Disabled                                                                                                                                                                                                              
Minimum Password Length: 5
[I] Found new SID:                                                                                                                                                                                                                         
S-1-22-1                                                                                                                                                                                                                                   
[I] Found new SID:                                                                                                                                                                                                                         
S-1-5-32                                                                                                                                                                                                                                   
[I] Found new SID:                                                                                                                                                                                                                         
S-1-5-32                                                                                                                                                                                                                                   
[I] Found new SID:                                                                                                                                                                                                                         
S-1-5-32                                                                                                                                                                                                                                   
[I] Found new SID:                                                                                                                                                                                                                         
S-1-5-32                                                                                                                                                                                                                                   
S-1-5-21-3544418579-3748865642-433680629-1000 MERCY\pleadformercy (Local User)
S-1-5-21-3544418579-3748865642-433680629-1001 MERCY\qiu (Local User)
[+] Enumerating users using SID S-1-22-1 and logon username '', password ''                                                                                                                                                                
S-1-22-1-1000 Unix User\pleadformercy (Local User)                                                                                                                                                                                         
S-1-22-1-1001 Unix User\qiu (Local User)
S-1-22-1-1002 Unix User\thisisasuperduperlonguser (Local User)
S-1-22-1-1003 Unix User\fluffy (Local User)
[+] Enumerating users using SID S-1-5-32 and logon username '', password ''                                                                                                                                                                

/tryharder/tryharder
It's annoying, but we repeat this over and over again: cyber hygiene is extremely important. Please stop setting silly passwords that will get cracked with any decent password list.

Once, we found the password "password", quite literally sticking on a post-it in front of an employee's desk! As silly as it may be, the employee pleaded for mercy when we threatened to fire her.

No fluffy bunnies for those who set insecure passwords and endanger the enterprise.

/etc/tomcat7/tomcat-users.xml
<tomcat-users>
<!--
  NOTE:  By default, no user is included in the "manager-gui" role required
  to operate the "/manager/html" web application.  If you wish to use this app,
  you must define such a user - the username and password are arbitrary.
-->
<!--
  NOTE:  The sample user and role entries below are wrapped in a comment
  and thus are ignored when reading this file. Do not forget to remove
  <!.. ..> that surrounds them.
-->
  <role rolename="admin-gui"/>
  <role rolename="manager-gui"/>
  <user username="thisisasuperduperlonguser" password="heartbreakisinevitable" roles="admin-gui,manager-gui"/>
  <user username="fluffy" password="freakishfluffybunny" roles="none"/>
</tomcat-users>


#####################################################
Take Away Concepts
• POP3
   ◇ Post Office Protocol 3
   ◇ receive emails from a remote server to a local email client
• IMAP
   ◇ The Internet Message Access Protocol
   ◇ accessing email on a remote web server from a local client
• When you find a potential password, try it everywhere for every user
• Upon the discovery of an Apache config file, there is a port knocking Daemon Configuration
   ◇ knocking on ports in a specific sequence a certain port will open automatically. 
   ◇ the sequence to open a specific port can be found within the Port Knocking Daemon Configuration
• How does tomcat store user credentials? 
   ◇ Tomcat version 7x stores the user:pass config 
   ◇ /etc/tomcat7/tomcat-users.xml
• Always check the file permission as this will indicate whether or not the current user can write to a file owned by root
   ◇ if our user can write to an executable file owned by root, this is not good
      ▪ especially if the execution of the file is done by www-data or another user we have control over
