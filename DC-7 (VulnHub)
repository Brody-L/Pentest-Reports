# DC-7
OS: Debian 7

Web Technology:

IP: 192.168.1.117

USERS: dc7user

CREDENTIALS:
dc7user : MdR3xOgB7#dW



#####################################################
Community Attack Vectors (To-Try List):
80 → Manual Inspection ("Think outside the box")
• Droopescan
[+] Themes found:
    startupgrowth_lite http://192.168.1.117:80/themes/startupgrowth_lite/
        http://192.168.1.117:80/themes/startupgrowth_lite/LICENSE.txt
[+] Possible version(s):
8.X
[+] Possible interesting urls found:
    Default admin - http://192.168.1.117:80/user/login

22 → login as user dc7user successful
[+] groups → dc7user, cdrom, floppy, audio, dip, video, plugdev, netdev


EXIM: Internet Mailer (4.89)
[+]Exim is a message transfer agent
[+]Exim has well-defined stages during which it gains or loses privileges
#####################################################
NMAP RESULTS:
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)
| ssh-hostkey: 
|   2048 d0:02:e9:c7:5d:95:32:ab:10:99:89:84:34:3d:1e:f9 (RSA)
|   256 d0:d6:40:35:a7:34:a9:0a:79:34:ee:a9:6a:dd:f4:8f (ECDSA)
|_  256 a8:55:d5:76:93:ed:4f:6f:f1:f7:a1:84:2f:af:bb:e1 (ED25519)
80/tcp open  http    Apache httpd 2.4.25 ((Debian))
|_http-title: Welcome to DC-7 | D7
| http-robots.txt: 22 disallowed entries (15 shown)
| /core/ /profiles/ /README.txt /web.config /admin/ 
| /comment/reply/ /filter/tips /node/add/ /search/ /user/register/ 
| /user/password/ /user/login/ /user/logout/ /index.php/admin/ 
|_/index.php/comment/reply/
|_http-generator: Drupal 8 (https://www.drupal.org)
|_http-server-header: Apache/2.4.25 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel


#####################################################
Steps Taken():
[+] nmap -p- -sC -sV $IP --open
[+] Ports 80 and 22 OPEN
[+] Clue to check “outside the box”
[+] droopescan scan drupal -u $URL
[+] Exact versioning detected with Droopescan
[+] wfuzz -c -z file,/opt/SecLists/Discovery/Web-Content/raft-large-files.txt --hc 404 “$URL”
[+] wfuzz -c -z file,/opt/SecLists/Discovery/Web-Content/raft-large-directories.txt --hc 404 “$URL”
[+] Username dc7user found at the bottom of the page
[+]Googling user dc7user landed credentials from a config.php page on github
[+] https://github.com/Dc7User/staffdb/blob/master/config.php
[+]SSH access using the credentials found on github
[+] mbox file found in dc7user home directory
[+]file contains email messages from the root user
[+]Received: from root by dc-7 with local (Exim 4.89)
[+]Subject: Cron <root@dc-7> /opt/scripts/backups.sh
[+] user www-data has write permissions to backups.sh
[+] drush gives user dc7user ability to change admin password
[+] with admin password, logging in to the drupal admin portal
[+] PHP module can be downloaded locally and added to drupal
[+] creating a basic webpage allows us to create web payload, reverse shell
[+] with shell access as user www-data, append “cp /bin/dash /var/tmp/dash ; chmod u+s /var/tmp/dash”
[+]when the backups.sh script runs, it will copy dash to /var/tmp/dash, which can be run by our user dc7user
[+]granting root access to the machine

#####################################################
Web Services Enumeration:  

[  +  NIKTO   ]

[  +  WFUZZ  ]

FILES:   /   (Web Root)
//DEFAULT DRUPAL INSTALL

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                            
=====================================================================

000000007:      301        9 L          28 W                    324 Ch          "install.php"                                      
000000001:      200        224 L    555 W       8743 Ch     "index.php"                                        
000000006:      200        339 L    2968 W              18092 Ch    "LICENSE.txt"                                      
000000024:      200        3 L          12 W                    95 Ch                   "INSTALL.txt"                                      
000000248:      200        61 L         185 W                   1594 Ch         "robots.txt"                                       
000000237:      200        11 L         14 W                    300 Ch          "rss.xml"                                          
000000212:      200        103 L        392 W           4555 Ch          "web.config"                                       
000001178:      200        139 L        760 W           5889 Ch         "README.txt"

DIRECTORIES:  /  (Web Root)
000000034:   200        237 L    522 W      8699 Ch     "node"                                             

#####################################################
OTHER:  
config.php
<?php
        $servername = "localhost";
        $username = "dc7user";
        $password = "MdR3xOgB7#dW";
        $dbname = "Staff";
        $conn = mysqli_connect($servername, $username, $password, $dbname);
?>

mbox
From root@dc-7 Thu Aug 29 17:00:22 2019
Return-path: <root@dc-7>
Envelope-to: root@dc-7
Delivery-date: Thu, 29 Aug 2019 17:00:22 +1000
Received: from root by dc-7 with local (Exim 4.89)
        (envelope-from <root@dc-7>)
        id 1i3EPu-0000CV-5C
        for root@dc-7; Thu, 29 Aug 2019 17:00:22 +1000

From: root@dc-7 (Cron Daemon)
To: root@dc-7
Subject: Cron <root@dc-7> /opt/scripts/backups.sh
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
X-Cron-Env: <PATH=/bin:/usr/bin:/usr/local/bin:/sbin:/usr/sbin>
X-Cron-Env: <SHELL=/bin/sh>
X-Cron-Env: <HOME=/root>
X-Cron-Env: <LOGNAME=root>
Message-Id: <E1i3EPu-0000CV-5C@dc-7>
Date: Thu, 29 Aug 2019 17:00:22 +1000

Database dump saved to /home/dc7user/backups/website.sql               [success]
gpg: symmetric encryption of '/home/dc7user/backups/website.tar.gz' failed: File exists
gpg: symmetric encryption of '/home/dc7user/backups/website.sql' failed: File exists

From root@dc-7 Thu Aug 29 17:15:11 2019
Return-path: <root@dc-7>
Envelope-to: root@dc-7
Delivery-date: Thu, 29 Aug 2019 17:15:11 +1000
Received: from root by dc-7 with local (Exim 4.89)
        (envelope-from <root@dc-7>)
        id 1i3EeF-0000Dx-G1
        for root@dc-7; Thu, 29 Aug 2019 17:15:11 +1000

From: root@dc-7 (Cron Daemon)
To: root@dc-7
Subject: Cron <root@dc-7> /opt/scripts/backups.sh
MIME-Version: 1.0sd
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
X-Cron-Env: <PATH=/bin:/usr/bin:/usr/local/bin:/sbin:/usr/sbin>
X-Cron-Env: <SHELL=/bin/sh>
X-Cron-Env: <HOME=/root>
X-Cron-Env: <LOGNAME=root>
Message-Id: <E1i3EeF-0000Dx-G1@dc-7>
Date: Thu, 29 Aug 2019 17:15:11 +1000

Database dump saved to /home/dc7user/backups/website.sql               [success]
gpg: symmetric encryption of '/home/dc7user/backups/website.tar.gz' failed: File exists
gpg: symmetric encryption of '/home/dc7user/backups/website.sql' failed: File exists

backups.sh
#!/bin/bash
rm /home/dc7user/backups/*
cd /var/www/html/
drush sql-dump --result-file=/home/dc7user/backups/website.sql
cd ..
tar -czf /home/dc7user/backups/website.tar.gz html/
gpg --pinentry-mode loopback --passphrase PickYourOwnPassword --symmetric /home/dc7user/backups/website.sql
gpg --pinentry-mode loopback --passphrase PickYourOwnPassword --symmetric /home/dc7user/backups/website.tar.gz
chown dc7user:dc7user /home/dc7user/backups/*
rm /home/dc7user/backups/website.sql
rm /home/dc7user/backups/website.tar.gz


SUIDs/GUIDs
find / -perm -u=s -type f 2>/dev/null
/bin/su
/bin/ping
/bin/umount
/bin/mount
/usr/sbin/exim4
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/gpasswd
/usr/bin/chfn
/usr/bin/newgrp

find / -perm -g=s -type f 2>/dev/null
/sbin/unix_chkpwd
/usr/bin/expiry
/usr/bin/ssh-agent
/usr/bin/crontab
/usr/bin/dotlockfile
/usr/bin/dotlock.mailutils
/usr/bin/bsd-write
/usr/bin/chage
/usr/bin/wall

ss -tunlp
Netid                   State                   Recv-Q Send-Q                   Local Address:Port                      Peer Address:Port              
udp                             UNCONN     0      0                           *:68                                                                              *:*                  
tcp                                     LISTEN     0      80                                    127.0.0.1:3306                                    *:*                  
tcp                                 LISTEN     0      128                               *:22                                                                                     *:*                  
tcp                                 LISTEN     0      20                                        127.0.0.1:25                                            *:*                  
tcp                                 LISTEN     0      128                               :::80                                                                                    :::*                  
tcp                                 LISTEN     0      128                               :::22                                                                                   :::*                  
tcp                                 LISTEN     0      20                                        ::1:25                                                                          :::* 

/var/www/html/sites/default/settings.php
$databases['default']['default'] = array (
  'database' => 'd7db',
  'username' => 'db7user',
  'password' => 'yNv3Po00',
  'prefix' => '',
  'host' => 'localhost',
  'port' => '',
  'namespace' => 'Drupal\\Core\\Database\\Driver\\mysql',
  'driver' => 'mysql',
);

#####################################################
Take Away Concepts
• if we find left-over install files or changelogs - we can more accurately aquire versioning information and more
• username enumeration through login attempt errors 
• SSH session, can I start monitoring the machine for I/O operations?
• CMS (Compromised):
   ◇ themes (upload a malicious theme)
   ◇ plugins (upload a malicious plugin)
   ◇ uploads (upload malicious content)
   ◇ installs
   ◇ downgrade attacks
   ◇ file upload
   ◇ upload permissability
   ◇ DB Information (download the database and explore it locally)
   ◇ raise or alter our user permissions to be able to do any of the above
